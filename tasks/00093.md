# Таймеры STM32
По функциональности таймеры в STM32 делятся на следующие группы:
1. базовые таймеры. Умеют только генерировать прерывания с заданной частотой;
2. таймер общего назначения. Имеют весь функционал базовых таймеров, но также могут измерять длительность импульсов и генерировать сигналы с широтно-импульсной модуляцией;
3. расширенные таймеры. Умею делать тоже самое, что и таймер общего назначения, но имеют дополндительные возможности по генерации сигналов для управления двигателями и периферией.

Рассмотрим общую структуру таймера на примере таймера общего назначения, представленного на рисунке 2.

![Alt text](https://sun9-7.userapi.com/c840532/v840532538/51da1/GJf_XTTjbAc.jpg)

Рисунок 2. Схема таймера общего назначения

Из основных элементов таймера выделим счетчик и каналы.

Рассмотрим сначала работу счетчика. На рисунке 3 изображена линия CK_PSC, от которой работает таймер. Обычно она подключена к системной шине и соответственно работает на частоте процессора. Прежде чем попасть на счетчик частота тактового сигнала уменьшается в PSC + 1 раз (данной значение можно настроить), и потом попадает на счетчик. Счетчик представляет собой обычный регистр. Каждый такт с CK_CNT, увеличивает, либо уменьшает его значение на 1. В случае увеличения, в какой-то момент счётчик достигает значения, которое равно значению в auto-reload регистре (рисунок 4.2.2). В этот момент генерируется событие, например прерывание, и потом счетчик сбрасывается в 0. После чего весь процесс повторяется снова.

![Alt text](https://sun9-7.userapi.com/c840532/v840532538/51daa/BCdXt8eJaw8.jpg)

Рисунок 3. Счетчик таймера

Так например, допустим что частота процессора 48 МГц, счетчик тактируется от системной шины, значение PSC равно 479, а значение autorelaod register равно 1999. В этом случае счетчик инкрементися с частотой 100 КГц (48000000 / (479+1) = 100000), и с частотой 50 Гц генерирует прерывания (100000 / (1999+1) = 50).

Кроме инкремена (up counting) счетчик так же можно настроить на декремент (down counting) или их комбинацию (center aligned). Изменение значения счетчика в этих случаях показано на рисунке 4. Синими стрелками отмечены моменты времена, когда могут генерироваться прерывания.

![Alt text](https://sun9-7.userapi.com/c840532/v840532538/51dbc/itTRPV7Czus.jpg)

Рисунок 4. Значение счетчика таймера во времени в зависимости от режима

Второй важной частью таймера является канал, обеспечивающий возможности изменения длительности входных сигналов, и генерации ШИМ. Центральной частью канала является capture/compare регистр (рисунок 5).

![Alt text](https://sun9-7.userapi.com/c840532/v840532538/51dc5/zLMW9WQ5LNk.jpg)

Рисунок 5. Схема первого канала таймера

Работа канала зависит от режима: либо захват сигнала, либо сравнение.

В режимет сравнения capture/compare регистр заранее записывается некоторое значение, которое постоянно сравнивается со значением счетчика. В случае если это значение меньше или равно значению счетчика, то канал на выходе выдает логическую 1, и если больше логический 0. Так например если значение счетчика изменяется от 0 до 500, то записав в capture/compare 400 или 200, то можно получить на выходе канала сигналы, как показано на рисунке 6. Так же в момент, когда значение capture/compare равно значению счетчика, можно генерировать прерывания.

![Alt text](https://sun9-7.userapi.com/c840532/v840532538/51dce/Jm9jMIUS7zI.jpg)

Рисунок 6. Пример выходного сигнала с канала таймер

В режиме захвата, в результате некоторого события, например изменения напряжения на пине, в capture/compare регистр записывается текущее значение счетчика, и может вызваться прерывание.

Из последнего отметим что таймер имеет один счетчик, но может иметь несколько канало (таймеры STM32 обычно имеют 4 канала).
