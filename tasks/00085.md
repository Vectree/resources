# Описание портов ввода-вывода

Как вы уже могли заметить, плата STM32F3Discover имеет большое количество контактов, называемых пинами (рисунок 1).

![Alt text](https://pp.userapi.com/c840221/v840221705/778f4/qcO1pQ8fbeU.jpg)

Рисунок 1. STM32F3Discovery

Пины объедены в группы, называемые портами. Каждый порт в STM32 имеет 16 пинов. Всего STM32F3Discovery имеет 6 портов: A, B, C, D, E, F.
Схематичное устройства одного интерфейса ввода-вывод представлено на
рисунке 2.

![Alt text](https://pp.userapi.com/c840221/v840221705/778fd/Fdl3Kl4j7Ak.jpg)

Рисунок 2. Схема GPIO микроконтроллера STM32

Как следует из схемы, интерфейс ввода-вывода может работать в одном из
следующих режимов:
1. цифровой выход общего назначения. В данном случае на пин программно
можно выставлять логический 0 (0 В) или 1 (+3.3 В)
2. цифровой вход общего назначения. В данном случае мы можем получать
текущее состояния пина: 1 или 0, т.е. подается ли на него напряжения (+3.3 В)
или нет (0 В).
3. альтернативных режим. В этом случае пин подключается к некоторому
периферийному устройству (таймер, шины I2C, SPI и т.д.), и управляется им.
4. аналоговых вход. Пин будет подключен АЦП (аналого-цифровой
преобразователь)
5. аналоговых выход. Пин будет подключен к ЦАП (цифро-аналоговый
преобразователь)

В режимах 3-5 мы не можем управлять пинами, т.к. они будут заняты
соответствующим устройствами.

В данной работе нас будут интересовать только режимы цифрового входа и выхода общего назначения.
Для управления пинами используется одиннадцать 32-х битных регистра. Из них нам будут интересны следующие:
1. **IDR** (input data register) регистр – позволяет считывать состояния пинов в режиме входа;
2. **ODR** (outputdataregister) регистр – позволяет устанавливать состояния пинов в режиме выхода;
3. **BSRR** (bit set/reset register) регистр – так же позволяет устанавливать состояния пинов в режиме выхода, но в отличии от ODR позволяет обращаться к отдельным пинам (используется для оптимизации работы с портом);
4. **BRR** (bit reset register) регистр – аналогично BSRR, но позволяет только сбрасывать пины

Регистры IDR и ODR имеют довольно простую структуру. Старшие 16 бит не
используются, а каждому n-му младшему биту соответствует n-й пин. Так, например, в таблице 1 приведен пример состояния ODR регистра, в котором 13, 12, 9, 8 и 4 пины установлены в логическую 1, а остальные в 0

![Alt text](https://pp.userapi.com/c840221/v840221705/77910/E2Eg2NMBdZc.jpg)

Таблица 1. Пример состояния регистра ODR

Однако несмотря на простоту, ODR регистр не позволяет оперировать отдельными битами, т.к. мы не можем записывать биты в память (с точки зрения программы все регистры устройств представляют из себя переменные в памяти с фиксированными адресами), поэту чтобы изменить состояния одного пина надо сначала считать регистр ODR, изменить нужный бит и обратно записать значения в ODR. Например, следующий код обнуляет 9-й пин и включает 11 не изменяя все остальные:

`GPIOE->ODR = (GPIOE->ODR & 0xFDFF) | 0x0800`

Регистр BSRR работает аналогично функции `HAL_GPIO_WritePin`. Установка в 1 битов старших 2-х байт сбрасывает соответсвующий пин, а младших включает. Приведем в качестве пример код, который делает то, что и предыдущий,
но с использованием BSRR регистра:

`GPIO-> BSRR = 0x02000800`

В случае если нужно только сбрасывать пины, то использовать BSRR не очень удобно, т.к. нужно будет не забывать сделать сдвиг на 16 битов в право. Чтобы этого не делать имеется BRR регистр, у которого младшие 16 бит используется для сброса пинов. Так следующий код сбрасывает 2 и 9-й пины с помощью данных регистров:

```c
GPIOE -> BSRR = 0x02020000
GPIOE -> BRR = 0x0202 // результат такой же, как и предыдущей строчке
```

#### Типы входов / выходов пинов

В зависимости от наличия резисторов между пином и землей или между пином и питанием выделяют 3 режима:
1. **pull-up** – с резистором подтягивающим к питанию;
2. **pull-down** – с резистором подтягивающим к земле;
3. **no-pull** – без подтягивающих резисторов;

![Alt text](https://pp.userapi.com/c840221/v840221705/77935/-bm7vjNcr2g.jpg)

Рисунок 3 Режимы подключения выходов пинов

В случае если пин работает в режиме выхода:
1. **pull-up** характеризуется тем что между пином и питанием стоит резистор
(рисунок 3 a). В случае если нужно получить на входе 1, то ключ между землей и пином размыкается, и резистор «подтягивает» напряжение. Для получения 0, ключ между землей и выходом пина просто замыкается.
2. **pull-down** – аналогично pull-up, но резистор стоит между пином и землей (рисунок 3 b).
3. **no-pull** – резисторов нет (рисунок 3 c). В случае если нужно получить 1, то пин просто подключается к питанию, если 0 – то к земле (соответственно ключи одновременно никогда не замыкаются).
В случае если пин работает в режиме входа:
1. **pull-up** – мы слушаем вход с пином подключенным к питанию (рисунок 3 d).
2. **pull-down** – мы слушаем вход с пином подключенным к земле (рисунок 3 e).
3. **no-pull** – мы слушаем вход соединенный только с пином (рисунок 3 а). 24
